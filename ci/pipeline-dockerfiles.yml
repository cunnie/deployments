# fly -t nono sp -p dockerfiles -c pipeline-dockerfiles.yml

resources:
# The repo with our sslip.io executable
- name: sslip.io-src
  type: git
  icon: github
  source:
    uri: https://github.com/cunnie/sslip.io.git
    paths:
    - bosh-release/src/sslip.io-dns-server/

# The repo with our nginx/HTML Dockerfile
- name: sslip.io-html
  type: git
  icon: github
  source:
    uri: https://github.com/cunnie/sslip.io.git
    paths:
    - k8s/document_root

# Where we will push the nginx Docker image with HTML assets
- name: sslip.io-nginx
  type: registry-image
  icon: docker
  source:
    repository: cunnie/sslip.io-nginx
    username: cunnie
    password: ((docker_token))
    tag: latest

# Where we will push the Docker image with the DNS server
- name: sslip.io-dns-server
  type: registry-image
  icon: docker
  source:
    repository: cunnie/sslip.io-dns-server
    username: cunnie
    password: ((docker_token))
    tag: latest

jobs:
- name: build-and-push-sslip.io-dns-server
  plan:
  - get: sslip.io-src
    trigger: true
  - task: build-task-image
    privileged: true
    config:
      platform: linux
      image_resource:
        type: registry-image
        source:
          repository: vito/oci-build-task
      inputs:
      - name: sslip.io-src
      outputs:
      - name: image
      params:
        CONTEXT: sslip.io-src/k8s/
        DOCKERFILE: sslip.io-src/k8s/Dockerfile-sslip.io-dns-server
      run:
        path: build
  - put: sslip.io-dns-server
    params:
      image: image/image.tar
- name: build-and-push-sslip.io-nginx
  plan:
  - get: sslip.io-html
    trigger: true
  - task: build-task-image
    privileged: true
    config:
      platform: linux
      image_resource:
        type: registry-image
        source:
          repository: vito/oci-build-task
      inputs:
      - name: sslip.io-html
      outputs:
      - name: image
      params:
        CONTEXT: sslip.io-html/k8s/
        DOCKERFILE: sslip.io-html/k8s/Dockerfile-nginx
      run:
        path: build
  - put: sslip.io-nginx
    params:
      image: image/image.tar
