#
# bosh -e vsphere -d sslip.io deploy sslip.io.yml -l <(lpass show --note deployments.yml) --no-redact
#
# I'd like to squash the instance groups, but `instance_groups.networks` prevents it
anchors:
  user_add_job: &user_add_job
    name: user_add
    properties:
      users:
      - name: cunnie
        public_key: ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIIWiAzxc4uovfaphO0QVC2w00YmzrogUpjAzvuqaQ9tD
          cunnie@nono.io
    release: os-conf
  nginx_job: &nginx_job
    name: nginx
    properties:
      nginx_conf: |
        user  nobody vcap; # group vcap can read /var/vcap/data/nginx
        worker_processes  1;
        error_log /var/vcap/sys/log/nginx/error.log   info;
        #pid        logs/nginx.pid; # PIDFILE is configured via monit's ctl
        events {
          worker_connections  1024;
        }
        http {
          include /var/vcap/packages/nginx/conf/mime.types;
          default_type  application/octet-stream;
          sendfile        on;
          keepalive_timeout  65;
          server_names_hash_bucket_size 64;
          # redirect HTTP to HTTPS
          server {
            server_name _; # invalid value which will never trigger on a real hostname.
            listen 80;
            rewrite ^ https://sslip.io$request_uri?;
            access_log /var/vcap/sys/log/nginx/sslip.io-access.log;
            error_log /var/vcap/sys/log/nginx/sslip.io-error.log;
          }
          server {
            server_name _ ;
            # weak DH https://weakdh.org/sysadmin.html
            ssl_ciphers 'ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-DSS-AES128-GCM-SHA256:kEDH+AESGCM:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-DSS-AES128-SHA256:DHE-RSA-AES256-SHA256:DHE-DSS-AES256-SHA:DHE-RSA-AES256-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:AES:CAMELLIA:DES-CBC3-SHA:!aNULL:!eNULL:!EXPORT:!DES:!RC4:!MD5:!PSK:!aECDH:!EDH-DSS-DES-CBC3-SHA:!EDH-RSA-DES-CBC3-SHA:!KRB5-DES-CBC3-SHA';
            ssl_prefer_server_ciphers on;
            # poodle https://scotthelme.co.uk/sslv3-goes-to-the-dogs-poodle-kills-off-protocol/
            ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
            listen              443 ssl;
            ssl_certificate     /var/vcap/jobs/nginx/etc/ssl_chained.crt.pem;
            ssl_certificate_key /var/vcap/jobs/nginx/etc/ssl.key.pem;
            access_log /var/vcap/sys/log/nginx/sslip.io-access.log;
            error_log /var/vcap/sys/log/nginx/sslip.io-error.log;
            root /var/vcap/data/nginx/document_root;
            index index.shtml index.html index.htm;
          }
        }
      pre_start: |
        #!/bin/bash -ex
        NGINX_DIR=/var/vcap/data/nginx
        mkdir -p /var/vcap/packages/nginx/proxy_temp
        cd $NGINX_DIR
        set +e
        curl -L http://api.github.com/repos/cunnie/sslip.io/tarball/master |
          tar xzf -
        mv cunnie-sslip.io-*/k8s/document_root .
        chown -R vcap:vcap .
      ssl_chained_cert: |
        -----BEGIN CERTIFICATE-----
        MIIEtzCCBF2gAwIBAgIQEKM9246l7jWUFwU8V/UQfzAKBggqhkjOPQQDAjCBjzEL
        MAkGA1UEBhMCR0IxGzAZBgNVBAgTEkdyZWF0ZXIgTWFuY2hlc3RlcjEQMA4GA1UE
        BxMHU2FsZm9yZDEYMBYGA1UEChMPU2VjdGlnbyBMaW1pdGVkMTcwNQYDVQQDEy5T
        ZWN0aWdvIEVDQyBEb21haW4gVmFsaWRhdGlvbiBTZWN1cmUgU2VydmVyIENBMB4X
        DTIxMTAyNjAwMDAwMFoXDTIyMDkxNDIzNTk1OVowFTETMBEGA1UEAwwKKi5zc2xp
        cC5pbzB2MBAGByqGSM49AgEGBSuBBAAiA2IABNl3lVauEsfLigOhiy/wTKeL+b4S
        njyC/rOuHo4x71XOMcBXwm4bl6bc15lDmn9nMHh+R15PP6W3Hva8eusGj0na5lqx
        N5ZBkvqC0ozflJRVrpaKkTFfzE4DsJFCp9RK3KOCAvUwggLxMB8GA1UdIwQYMBaA
        FPaFCjsRhuEEfQ6qCyzS7sxke3uuMB0GA1UdDgQWBBREW0PY3n3VsLSYpAB1b47v
        ngjWdTAOBgNVHQ8BAf8EBAMCB4AwDAYDVR0TAQH/BAIwADAdBgNVHSUEFjAUBggr
        BgEFBQcDAQYIKwYBBQUHAwIwSQYDVR0gBEIwQDA0BgsrBgEEAbIxAQICBzAlMCMG
        CCsGAQUFBwIBFhdodHRwczovL3NlY3RpZ28uY29tL0NQUzAIBgZngQwBAgEwgYQG
        CCsGAQUFBwEBBHgwdjBPBggrBgEFBQcwAoZDaHR0cDovL2NydC5zZWN0aWdvLmNv
        bS9TZWN0aWdvRUNDRG9tYWluVmFsaWRhdGlvblNlY3VyZVNlcnZlckNBLmNydDAj
        BggrBgEFBQcwAYYXaHR0cDovL29jc3Auc2VjdGlnby5jb20wHwYDVR0RBBgwFoIK
        Ki5zc2xpcC5pb4IIc3NsaXAuaW8wggF9BgorBgEEAdZ5AgQCBIIBbQSCAWkBZwB2
        AEalVet1+pEgMLWiiWn0830RLEF0vv1JuIWr8vxw/m1HAAABfLoFkFgAAAQDAEcw
        RQIhAJWk1lnD21pk5wVgyJ6ZmaYD0K0rqBrwwEgJYijGR6TXAiA4ZCMqwdL18nnJ
        79rgVIoWpolJcZOTu/Ktd9UusAFOiwB1AEHIyrHfIkZKEMahOglCh15OMYsbA+vr
        S8do8JBilgb2AAABfLoFkCcAAAQDAEYwRAIgL4R1Y4p1ANoeOsoaLkzj9ORUNDdp
        TbO62tKaNRED7pcCIE2LmXsMq8eJSiZ3llyXCgFQiQRFJcWyF9ZGY4DB1MApAHYA
        KXm+8J45OSHwVnOfY6V35b5XfZxgCvj5TV0mXCVdx4QAAAF8ugWP9QAABAMARzBF
        AiEAgJ32lG532KMSl/juM193kRGbG2AP1dg0Wrp8ub9A1EICIDvZ6j6R3jsUsINk
        MMgtsezyui5qEaDnkmuovDWoOSmCMAoGCCqGSM49BAMCA0gAMEUCIH38J/0kuZJc
        iAmV4ewylk47/CnM56RgOoR5MqIb1UiFAiEAl+/OUgYDeINU+TynGf5Y79yVqWrX
        qpri6NRpg+fq0w0=
        -----END CERTIFICATE-----
        -----BEGIN CERTIFICATE-----
        MIIDqDCCAy6gAwIBAgIRAPNkTmtuAFAjfglGvXvh9R0wCgYIKoZIzj0EAwMwgYgx
        CzAJBgNVBAYTAlVTMRMwEQYDVQQIEwpOZXcgSmVyc2V5MRQwEgYDVQQHEwtKZXJz
        ZXkgQ2l0eTEeMBwGA1UEChMVVGhlIFVTRVJUUlVTVCBOZXR3b3JrMS4wLAYDVQQD
        EyVVU0VSVHJ1c3QgRUNDIENlcnRpZmljYXRpb24gQXV0aG9yaXR5MB4XDTE4MTEw
        MjAwMDAwMFoXDTMwMTIzMTIzNTk1OVowgY8xCzAJBgNVBAYTAkdCMRswGQYDVQQI
        ExJHcmVhdGVyIE1hbmNoZXN0ZXIxEDAOBgNVBAcTB1NhbGZvcmQxGDAWBgNVBAoT
        D1NlY3RpZ28gTGltaXRlZDE3MDUGA1UEAxMuU2VjdGlnbyBFQ0MgRG9tYWluIFZh
        bGlkYXRpb24gU2VjdXJlIFNlcnZlciBDQTBZMBMGByqGSM49AgEGCCqGSM49AwEH
        A0IABHkYk8qfbZ5sVwAjBTcLXw9YWsTef1Wj6R7W2SUKiKAgSh16TwUwimNJE4xk
        IQeV/To14UrOkPAY9z2vaKb71EijggFuMIIBajAfBgNVHSMEGDAWgBQ64QmG1M8Z
        wpZ2dEl23OA1xmNjmjAdBgNVHQ4EFgQU9oUKOxGG4QR9DqoLLNLuzGR7e64wDgYD
        VR0PAQH/BAQDAgGGMBIGA1UdEwEB/wQIMAYBAf8CAQAwHQYDVR0lBBYwFAYIKwYB
        BQUHAwEGCCsGAQUFBwMCMBsGA1UdIAQUMBIwBgYEVR0gADAIBgZngQwBAgEwUAYD
        VR0fBEkwRzBFoEOgQYY/aHR0cDovL2NybC51c2VydHJ1c3QuY29tL1VTRVJUcnVz
        dEVDQ0NlcnRpZmljYXRpb25BdXRob3JpdHkuY3JsMHYGCCsGAQUFBwEBBGowaDA/
        BggrBgEFBQcwAoYzaHR0cDovL2NydC51c2VydHJ1c3QuY29tL1VTRVJUcnVzdEVD
        Q0FkZFRydXN0Q0EuY3J0MCUGCCsGAQUFBzABhhlodHRwOi8vb2NzcC51c2VydHJ1
        c3QuY29tMAoGCCqGSM49BAMDA2gAMGUCMEvnx3FcsVwJbZpCYF9z6fDWJtS1UVRs
        cS0chWBNKPFNpvDKdrdKRe+oAkr2jU+ubgIxAODheSr2XhcA7oz9HmedGdMhlrd9
        4ToKFbZl+/OnFFzqnvOhcjHvClECEQcKmc8fmA==
        -----END CERTIFICATE-----
        -----BEGIN CERTIFICATE-----
        MIID0zCCArugAwIBAgIQVmcdBOpPmUxvEIFHWdJ1lDANBgkqhkiG9w0BAQwFADB7
        MQswCQYDVQQGEwJHQjEbMBkGA1UECAwSR3JlYXRlciBNYW5jaGVzdGVyMRAwDgYD
        VQQHDAdTYWxmb3JkMRowGAYDVQQKDBFDb21vZG8gQ0EgTGltaXRlZDEhMB8GA1UE
        AwwYQUFBIENlcnRpZmljYXRlIFNlcnZpY2VzMB4XDTE5MDMxMjAwMDAwMFoXDTI4
        MTIzMTIzNTk1OVowgYgxCzAJBgNVBAYTAlVTMRMwEQYDVQQIEwpOZXcgSmVyc2V5
        MRQwEgYDVQQHEwtKZXJzZXkgQ2l0eTEeMBwGA1UEChMVVGhlIFVTRVJUUlVTVCBO
        ZXR3b3JrMS4wLAYDVQQDEyVVU0VSVHJ1c3QgRUNDIENlcnRpZmljYXRpb24gQXV0
        aG9yaXR5MHYwEAYHKoZIzj0CAQYFK4EEACIDYgAEGqxUWqn5aCPnetUkb1PGWthL
        q8bVttHmc3Gu3ZzWDGH926CJA7gFFOxXzu5dP+Ihs8731Ip54KODfi2X0GHE8Znc
        JZFjq38wo7Rw4sehM5zzvy5cU7Ffs30yf4o043l5o4HyMIHvMB8GA1UdIwQYMBaA
        FKARCiM+lvEH7OKvKe+CpX/QMKS0MB0GA1UdDgQWBBQ64QmG1M8ZwpZ2dEl23OA1
        xmNjmjAOBgNVHQ8BAf8EBAMCAYYwDwYDVR0TAQH/BAUwAwEB/zARBgNVHSAECjAI
        MAYGBFUdIAAwQwYDVR0fBDwwOjA4oDagNIYyaHR0cDovL2NybC5jb21vZG9jYS5j
        b20vQUFBQ2VydGlmaWNhdGVTZXJ2aWNlcy5jcmwwNAYIKwYBBQUHAQEEKDAmMCQG
        CCsGAQUFBzABhhhodHRwOi8vb2NzcC5jb21vZG9jYS5jb20wDQYJKoZIhvcNAQEM
        BQADggEBABns652JLCALBIAdGN5CmXKZFjK9Dpx1WywV4ilAbe7/ctvbq5AfjJXy
        ij0IckKJUAfiORVsAYfZFhr1wHUrxeZWEQff2Ji8fJ8ZOd+LygBkc7xGEJuTI42+
        FsMuCIKchjN0djsoTI0DQoWz4rIjQtUfenVqGtF8qmchxDM6OW1TyaLtYiKou+JV
        bJlsQ2uRl9EMC5MCHdK8aXdJ5htN978UeAOwproLtOGFfy/cQjutdAFI3tZs4RmY
        CV4Ks2dH/hzg1cEo70qLRDEmBDeNiXQ2Lu+lIg+DdEmSx/cQwgwp+7e9un/jX9Wf
        8qn0dNW44bOwgeThpWOjzOoEeJBuv/c=
        -----END CERTIFICATE-----
      ssl_key: ((sslip_io_key))
    release: nginx
  ntpd_job: &ntpd_job
    name: ntpd
    properties:
      ntp_conf: |
        # Our upstream timekeepers; thank you Google
        server time1.google.com iburst
        server time2.google.com iburst
        server time3.google.com iburst
        server time4.google.com iburst
        # "Batten down the hatches!"
        # see http://support.ntp.org/bin/view/Support/AccessRestrictions
        restrict default limited kod nomodify notrap nopeer
        # Amazon AWS doesn't have IPv6, but I restrict it anyway
        restrict -6 default limited kod nomodify notrap nopeer
        restrict 127.0.0.0 mask 255.0.0.0
        restrict -6 ::1
      post_start: |
        #!/bin/bash -x
        # on bionic we disable chrony because we're running ntpd
        systemctl disable chrony.service
        systemctl stop    chrony.service
    release: ntp
instance_groups:
- azs:
  - azure
  instances: 1
  jobs:
  - *user_add_job
  - *nginx_job
  - name: sslip.io-dns-server
    release: sslip.io
  name: azure
  networks:
  - default:
    - dns
    - gateway
    name: azure-private
  - name: azure-public
    static_ips:
    - 52.187.42.158
  stemcell: bionic
  vm_type: standard_b1s
- azs:
  - vsphere
  instances: 1
  jobs:
  - *user_add_job
  - name: worker
    properties:
      drain_timeout: 10m
      worker_gateway:
        host_public_key: ((tsa_host_key.public_key))
        hosts: ci.nono.io:2222
        worker_key: ((worker_key))
    release: concourse
  name: worker
  networks:
  - name: vsphere-guest
  stemcell: bionic
  vm_type: concourse-workers
name: sslip.io
releases:
- name: concourse
  sha1: af1af947e61a50a9828e0120fb4366c4ef56b01a
  url: https://bosh.io/d/github.com/concourse/concourse-bosh-release?v=7.5.0
  version: 7.5.0
- name: bpm
  sha1: 82322898b2393951108617caac43752e498632a2
  url: https://bosh.io/d/github.com/cloudfoundry/bpm-release?v=1.1.13
  version: 1.1.13
- name: postgres
  sha1: e44bbe8f8a7cdde1cda67b202e399a239d104db6
  url: https://bosh.io/d/github.com/cloudfoundry/postgres-release?v=43
  version: "43"
- name: os-conf
  version: "22.1.0"
  url: "https://bosh.io/d/github.com/cloudfoundry/os-conf-release?v=22.1.0"
  sha1: "7ef05f6f3ebc03f59ad8131851dbd1abd1ab3663"
- name: "nginx"
  version: "1.21.3"
  url: "https://bosh.io/d/github.com/cloudfoundry-community/nginx-release?v=1.21.3"
  sha1: "f7ae6bd2268da775b146498d9937ba1e9e22f78d"
- name: ntp
  sha1: 591eb51e3257aa07b6ef9c0bb6128df53835fa20
  url: https://bosh.io/d/github.com/cloudfoundry-community/ntp-release?v=4.2.8p13
  version: 4.2.8p13
- name: sslip.io
  sha1: 942114276c39932e3f79571def32b19e38f535be
  url: https://github.com/cunnie/sslip.io/releases/download/2.2.2/sslip.io-release-2.2.2.tgz
  version: 2.2.2
- name: sysctl
  version: latest
stemcells:
- alias: bionic
  os: ubuntu-bionic
  version: latest
update:
  canaries: 1
  canary_watch_time: 1000-60000
  max_in_flight: 3
  serial: false
  update_watch_time: 1000-60000
